<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0,minimun-scale=1,maximum-scale=1,suer-scale=no">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>合成页面</title>
		<link rel="stylesheet" href="./css/bootstrap.min.css" />
		<link rel="stylesheet" href="./css/index.css" />
	</head>

	<body>
		<section class="warehouse">
			<img src="./imgaes/warehouse/BG.png" class="img-responsive warehouse_back" alt="php" />
			<div id="" class="warehouse_outside">
				<!--标题-->
				<div id="" class="warehouse_inside">
					<img class="warehouse_title" src="./imgaes/warehouse/标题文字.png" />
				</div>
				<!--
                	组合旋转
                -->
				<div id="" class="center">
					<div id="" class="and_outside">
						<div id="" class="and_inside">
							<img class="and_img1" src="./imgaes/warehouse/合成按钮.png" />
						</div>
					</div>
					<div id="" class="and_outside1">
						<div id="" class="and_inside1">
							<div class="sum sum1">
								12
							</div>
							<img class="and_img1" src="./imgaes/warehouse/泡泡.png" />
							<img class="and_img" src="./imgaes/warehouse/prize1_1.png" />
						</div>
					</div>
					<div id="" class="and_outside2">
						<div id="" class="and_inside1 and_tr1">
							<div class="sum sum2">
								12
							</div>
							<img class="and_img1" src="./imgaes/warehouse/泡泡.png" />
							<img class="and_img" src="./imgaes/warehouse/prize2_1.png" />

						</div>
					</div>
					<div id="" class="and_outside3">
						<div id="" class="and_inside1 and_tr2">
							<div class="sum sum3">
								12
							</div>
							<img class="and_img1" src="./imgaes/warehouse/泡泡.png" />
							<img class="and_img" src="./imgaes/warehouse/prize3_1.png" />

						</div>
					</div>
					<div id="" class="and_outside4">
						<div id="" class="and_inside1 and_tr3">
							<div class="sum sum4">
								12
							</div>
							<img class="and_img1" src="./imgaes/warehouse/泡泡.png" />
							<img class="and_img" src="./imgaes/warehouse/prize4_1.png" />

						</div>
					</div>
					<div id="" class="and_outside5">
						<div id="" class="and_inside1 and_tr4">
							<div class="sum sum5">
								12
							</div>
							<img class="and_img1" src="./imgaes/warehouse/泡泡.png" />
							<img class="and_img" src="./imgaes/warehouse/prize5_1.png" />

						</div>
					</div>
				</div>
				<!--公告区-->

				<div id="" class="doc">
					<div id="" class="doc_in">
						<div id="marquee6">
							<ul id='ul'>
								<li>
									<a href='javascript:;'>
										<img src='./imgaes/warehouse/喇叭.png' /> 恭喜
										
										<span  class="doc1"></span> 合成
										
										<span  class="doc2"></span></a>
								</li>
								<li>
									<a href='javascript:;'>
										<img src='./imgaes/warehouse/喇叭.png' /> 恭喜
										
										<span  class="doc1"></span> 合成
										
										<span  class="doc2"></span></a>
								</li>
								<li>
									<a href='javascript:;'>
										<img src='./imgaes/warehouse/喇叭.png' /> 恭喜
										
										<span  class="doc1"></span> 合成
										
										<span  class="doc2"></span></a>
								</li>
								<li>
									<a href='javascript:;'>
										<img src='./imgaes/warehouse/喇叭.png' /> 恭喜
										
										<span  class="doc1"></span> 合成
										
										<span  class="doc2"></span></a>
								</li>
								<li>
									<a href='javascript:;'>
										<img src='./imgaes/warehouse/喇叭.png' /> 恭喜
										
										<span  class="doc1"></span> 合成
										
										<span  class="doc2"></span></a>
								</li>
								<li>
									<a href='javascript:;'>
										<img src='./imgaes/warehouse/喇叭.png' /> 恭喜
										
										<span  class="doc1"></span> 合成
										
										<span  class="doc2"></span></a>
								</li>
								<li>
									<a href='javascript:;'>
										<img src='./imgaes/warehouse/喇叭.png' /> 恭喜
										
										<span  class="doc1"></span> 合成
										
										<span  class="doc2"></span></a>
								</li>
								<li>
									<a href='javascript:;'>
										<img src='./imgaes/warehouse/喇叭.png' /> 恭喜
										
										<span  class="doc1"></span> 合成
										
										<span  class="doc2"></span></a>
								</li>
								<li>
									<a href='javascript:;'>
										<img src='./imgaes/warehouse/喇叭.png' /> 恭喜
										
										<span  class="doc1"></span> 合成
										
										<span  class="doc2"></span></a>
								</li>
								<li>
									<a href='javascript:;'>
										<img src='./imgaes/warehouse/喇叭.png' /> 恭喜
										
										<span  class="doc1"></span> 合成
										
										<span  class="doc2"></span></a>
								</li>

							</ul>
						</div>

					</div>
				</div>
				<!-- Modal -->
		<div class="model1" >
			<div id="" class="model_outside">
				<div id="" class="model_inside">

					<img src="./imgaes/warehouse/恭喜你合成.png" class="img-responsive model_img" alt="php" />

					<img src="" class="model_gilf" />
					<img src="./imgaes/start/start4.png"  class=" model_colse" />
					<img src="./imgaes/start/start2.png" class="model_btn_warehouse" />
				</div>
			</div>
		</div>
		<div class="model2" >
			<div id="" class="model_outside">
				<div id="" class="model_inside">

					<img src="./imgaes/warehouse/没有集齐.png" class="img-responsive model_img" alt="php" />

					<img src="imgaes/warehouse/您的柠檬仔数量不足.png" class="model_gilf2" />
					<img src="./imgaes/start/start4.png"  class=" model_colse" />

				</div>
			</div>
		</div>
		</section>
		<script src="./js/jquery-3.1.1.min.js"></script>
		<script type="text/javascript" src="./js/Marquee.js"></script>
		<script type="text/javascript">
			
				// 类型判断
				var type = 'syn_coupons';
				// 添加奖励物品1
				var prize = ''; // 合成物品
				// 添加奖励物品2
				var fishing_openid = ''; // 微信图像
				// 添加奖励物品3
				var fishing_coupons = ''; // 优惠券
				// 用户id
				var openid = 'osMntsgeYclxPrMl7F8mZ3hbJRIk'; //osMntsgeYclxPrMl7F8mZ3hbJRIk
				// 用户昵称
				var nickname = '杨福';
				// 用户性别
				var sex='1';
				// 用户图像
				var head='http://thirdwx.qlogo.cn/mmopen/vi_32/ydQX6UbSCURDQJY1hFCvl8QUpep2mo5Cy2OG7WeUOXhkAGPvlOLBT6xm6dyIYvAsWO22HOFK89hMjPXhlia3yPQ/132'

				// 获奖名单
				var doc = [];
				// 合成物品数量
				var prize1 = 0;
				var prize2 = 0;
				var prize3 = 0;
				var prize4 = 0;
				var prize5 = 0;
				// 外层容器宽
				var wid = $('.and_outside')[0].offsetWidth;
				// 内层容器
				var and_inside = $('.and_inside');
				// 设置外层容器高
				$('.and_outside')[0].style.height = wid + "px";
				$('.and_outside1')[0].style.height = wid + "px";
				$('.and_outside2')[0].style.height = wid + "px";
				$('.and_outside3')[0].style.height = wid + "px";
				$('.and_outside4')[0].style.height = wid + "px";
				$('.and_outside5')[0].style.height = wid + "px";
				$('.center')[0].style.height = wid + "px";

				rePost();
				getText();
				//  连接服务器
								var ws = new WebSocket('ws://118.89.20.208:8585');
				  //握手函数
								ws.onopen = function() {
									//状态为1证明握手成功，然后把client自定义的名字发送过去
									if(ws.readyState == 1) {
										ws.send('type=add&ming='+nickname+'&head='+head+'&role=2&sex='+sex+'&openid='+openid);
									};
								}
								//握手失败或者其他原因连接socket失败，则清除so对象并做相应提示操作
								ws.onclose = function() {
									ws.send('type=remove&ming='+nickname+'&head='+head+'&role=2&sex='+sex+'&openid='+openid);
									ws = false;
									//						lct.appendChild(A.$$('<p class="c2">退出聊天室</p>'));
								}
								//数据接收监听，接收服务器推送过来的信息，返回的数据给msg，然后进行显示
								ws.onmessage = function(msg) {	
									// 类型改变
								}				
				// 点击合成 
				$('.and_img1')[0].addEventListener('click', function() {
					// 判断是否满足合成条件
					if(prize1>0 && prize2>0 && prize3>0 && prize4>0 && prize5>0){
						$('.model1')[0].style.display = 'block';
						init()
					}else{					
						$('.model2')[0].style.display = 'block';
						
					}	
				})
				$('.model_btn_warehouse')[0].addEventListener('click', function() {
					$('.model1')[0].style.display = 'none';
					$('.model2')[0].style.display = 'none';
				})
				$('.model_colse')[0].addEventListener('click', function() {
					$('.model1')[0].style.display = 'none';
					$('.model2')[0].style.display = 'none';
				})
			$('.model_colse')[1].addEventListener('click', function() {
					$('.model1')[0].style.display = 'none';
					$('.model2')[0].style.display = 'none';
				})
				
				
						
				lunBo()
				function reSum(){
						$('.sum')[0].innerText=prize1
						$('.sum')[1].innerText=prize2
						$('.sum')[2].innerText=prize3
						$('.sum')[3].innerText=prize4
						$('.sum')[4].innerText=prize5
				}
				// 合成的奖励
				function addCoupons(){
					var sum=Math.floor(Math.random()*9)
					if(sum<4){ // 概率40%
						fishing_coupons='满10减2元券'
						$('.model_gilf')[0].src='./imgaes/start_last/couponsOne.png'
					}else
					if(sum<7){ // 概率30%
						fishing_coupons='满20减5元券'
						$('.model_gilf')[0].src='./imgaes/start_last/couponsTwo.png'

					}else
					if(sum<9){ // 概率20%
						fishing_coupons='买一送一券'
						$('.model_gilf')[0].src='./imgaes/start_last/couponsThree.png'

					}else{ // 概率10%
						fishing_coupons='免费领取一杯奶茶'
						$('.model_gilf')[0].src='./imgaes/start_last/coupons4.png'

					}
				}
				// 判断点亮图标
				function rePrize() {
					// 点亮图标
					if(prize1 > 0) {
						$('.and_img')[0].src = './imgaes/warehouse/prize1.png';
					}else{
						$('.and_img')[0].src = './imgaes/warehouse/prize1_1.png';
					}
					if(prize2 > 0) {
						$('.and_img')[1].src = './imgaes/warehouse/prize2.png';
					}else{
						$('.and_img')[1].src = './imgaes/warehouse/prize2_1.png';
					}
					if(prize3 > 0) {
						$('.and_img')[2].src = './imgaes/warehouse/prize3.png';
					}else{
						$('.and_img')[2].src = './imgaes/warehouse/prize3_1.png';
					}
					if(prize4 > 0) {
						$('.and_img')[3].src = './imgaes/warehouse/prize4.png';
					}else{
						$('.and_img')[3].src = './imgaes/warehouse/prize4_1.png';
					}
					if(prize5 > 0) {
						$('.and_img')[4].src = './imgaes/warehouse/prize5.png';
					}else{
						$('.and_img')[4].src = './imgaes/warehouse/prize5_1.png';
					}
				}

						
					
								// 添加合成物品
				function addPost() {
					// 添加数据
					$.post(
					// 请求地址
					'http://mq.soratech.cn/web_sock/public/index/index/user_update',
					// 数据data
					{
						data:[{
							type: type,
							prize: prize,
							fishing_openid: fishing_openid,
							fishing_coupons:fishing_coupons }
							],
						openid: openid,
						nickname:nickname
						
					},
					// 成功回调函数
					function (msg) {
										
								prize1 = prize1-1;
								prize2 = prize2-1;
								prize3 = prize3-1;
								prize4 = prize4-1;
								prize5 = prize5-1;	
						reSum();
						rePrize()
					})
				};
				// 获取合成需要的基础图标
				function rePost() {
					// 更新数据
					$.post(
						"http://mq.soratech.cn/web_sock/public/index/index/user_sel",
						{
							openid: openid
						},
						function(msg) {
							if(msg) {
								var data = JSON.parse(msg);
								prize1 = data.prize1;
								prize2 = data.prize2;
								prize3 = data.prize3;
								prize4 = data.prize4;
								prize5 = data.prize5;
								reSum();
								rePrize();
							}
						}
					)
				};
				// 获取所有的合成数据
				function getText(){
					$.post(
						"http://mq.soratech.cn/web_sock/public/index/index/log_sel",
						{},
						function(msg){
							try{
								var data=JSON.parse(msg)
								doc = data
								writeText()
							}catch(e){
								//TODO handle the exception
							}
						}
					)
				}
				// 轮播信息写入页面
				function writeText(){
					for(var i=0;i<$('li').length;i++){
						
						if(i<doc.length){
							$('.doc1')[i].innerText=doc[i].nickname
							$('.doc2')[i].innerText=doc[i].coupons	
						}else{
							$('li')[i].style.display='none'
						}
										
					}

				}
				//Marquee
				// 轮播合成信息
				function lunBo(){
					$('#marquee6').kxbdSuperMarquee({
						isMarquee: true,
						isEqual: false,

						scrollDelay: 30,
						direction: 'down'
					});
					
				}

				function init(){ // 初始化
					addCoupons();
					addPost();
					rePost();
					getText()				
					fishing_coupons = ''; // 优惠券
					navigator.vibrate(1000); // 手机震动
			}
		</script>
	
	</body>

</html>