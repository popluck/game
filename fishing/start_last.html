<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0,minimun-scale=1,maximum-scale=1,suer-scale=no">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>疯狂时刻</title>
		<link rel="stylesheet" href="./css/bootstrap.min.css" />
		<link rel="stylesheet" href="./css/index.css" />
		</head>

	<body> 
		<section id="start">
			<img src="./imgaes/start_last/BG.png" class="img-responsive start_back" alt="php" />
			<img src="./imgaes/start_last/web-12.png" id="start_fish" class="img-responsive re1_1" alt="php" />
			<a class=" re2_2" id="start_btn" href="javascript:;"><img src="./imgaes/start_last/start_btn.png" class="img-responsive " alt="php" /></a>
		</section>
		<!-- Modal -->
		<div class="model1">
			<div id="" class="model_outside">
				<div id="" class="model_inside">

					<img src="./imgaes/start_last/恭喜你钓到.png" class="img-responsive model_img" alt="php" />
					<div id="" class="model_gilf1">
						<div id="" class="lun">
							
								<img class="left" src="imgaes/start_last/矢量智能对象拷贝3.png"/>
							
							
								<img class="center" src="imgaes/start_last/优惠券1.png"/>
							
							
								<img class="right" src="imgaes/start_last/矢量智能对象拷贝3.png"/>
								
							
						</div>
					</div>
					<img src="./imgaes/start_last/start4.png" data-dismiss="modal" class=" model_colse" />
					<img src="./imgaes/start_last/start2.png" class="model_btn1" data-dismiss="modal" alt="php" />
				</div>
			</div>
		</div>
		<script src="./js/jquery-3.1.1.min.js"></script>
		<script>
			// 类型判断
			var type = '';
			// 添加奖励物品1
			var prize = []; // 合成物品
			// 添加奖励物品2
			var fishing_openid = ''; // 微信图像
			// 添加奖励物品3
			var fishing_coupons = []; // 优惠券

			var openid = 'osMntsgeYclxPrMl7F8mZ3hbJRIk'; // 用户id
			var nickname = '杨福'; // 用户昵称
			var sex='1'; // 用户性别
			var head='http://thirdwx.qlogo.cn/mmopen/vi_32/ydQX6UbSCURDQJY1hFCvl8QUpep2mo5Cy2OG7WeUOXhkAGPvlOLBT6xm6dyIYvAsWO22HOFK89hMjPXhlia3yPQ/132' // 用户图像
			var btn = $('.re2_2')[0];
			var img = $('.re1_1')[0];
			var a = 1; //点击数
			var rand; //随机次数
			// 获奖礼物
			var cent_index=0;
			var cent_img=["couponsThree","couponsOne","prize1","couponsThree"]
			// 渔网变化图片
			var webs = ['web-1.png', 'web-2.png', 'web-3.png', 'web-4.png', 'web-5.png', 'web-6.png', 'web-7.png', 'web-8.png', 'web-9.png', 'web-10.png', 'web-12.png']
			// 渔网数组index
			var index = 0;
			var addData=[]
			for(var i=0;i<prize.length-1;i++){
				var data={
							"type": "prize",
							"prize": prize[i],
						}
				addData.push(data)
			}
			for(var i=0;i<fishing_coupons.length-1;i++){
				var data={
							"type": "coupons",
							"fishing_coupons": fishing_coupons[i],
						}
				addData.push(data)
			}
			// 连接服务器
			var ws = new WebSocket('ws://118.89.20.208:8585');
			// 握手函数
			ws.onopen = function() {
				//状态为1证明握手成功，然后把client自定义的名字发送过去
				if(ws.readyState == 1) {
					ws.send('type=add&ming='+nickname+'&head='+head+'&role=2&sex='+sex+'&openid='+openid);
				};
			}
			//握手失败或者其他原因连接socket失败，则清除so对象并做相应提示操作
			ws.onclose = function() {
				ws.send('type=remove&ming='+nickname+'&head='+head+'&role=2&sex='+sex+'&openid='+openid);
				ws = false;
			}
			//数据接收监听，接收服务器推送过来的信息，返回的数据给msg，然后进行显示
			ws.onmessage = function(msg) {
				console.log(msg)
				if(msg.data) {
					var data = JSON.parse(msg.data).nrong;
						console.log(data,2) 
						try{
								data = JSON.parse(data)									
								cent_img=data.coupons
								for(var i=0;i<data.prize.length-1;i++){
									var stt='prize'+String(Math.floor(Math.random()*4)+1)
									prize.push(stt)
									cent_img.push(stt)
								}
								for(var i=0;i<data.wechat.length-1;i++){
									var stt='prize'+String(Math.floor(Math.random()*4)+1)
									prize.push(stt)
									cent_img.push(stt)
								}
								for(var i=0;i<data.coupons.length-1;i++){
									if(data.coupons[i]=="couponsThree"){
										fishing_coupons.push("满10减2元券")
									}
									if(data.coupons[i]=="couponsTwo"){
										fishing_coupons.push("满20减5元券")
									}
									if(data.coupons[i]=="couponsOne"){
										fishing_coupons.push("买一送一券")
									}
								}
								console.log(cent_img)
								
						}catch(e){
						}
				}
				console.log(data)
			}
			// 手机摇一摇判断
			if(window.DeviceMotionEvent) {
				var speed = 25;
				var x = y = z = lastX = lastY = lastZ = 0;
				window.addEventListener('devicemotion', function() {
					var acceleration = event.accelerationIncludingGravity;
					x = acceleration.x;
					y = acceleration.y;
					if(Math.abs(x - lastX) > speed || Math.abs(y - lastY) > speed) {
						btn.click()
					}
					lastX = x;
					lastY = y;
				}, false);
			}
			btn.addEventListener('click', shake)
			$('.model_btn1')[0].addEventListener('click', function(){
				$('.model1')[0].style.display='none';
				btn.addEventListener('click', shake)
				cent_img=null

			})
			$('.model_colse')[0].addEventListener('click', function(){
				$('.model1')[0].style.display='none';
				btn.addEventListener('click', shake)
				cent_img=null

			})

			$('.left')[0].addEventListener('click',ckLeft)
			$('.right')[0].addEventListener('click',ckRight)
			function ckLeft(){
				if(cent_index>0){
					cent_index--
				}else{
					cent_index=cent_img.length-1
				}

				$('.center')[0].src='./imgaes/start_last/'+cent_img[cent_index]+'.png'
			}
			function ckRight(){
				if(cent_index<cent_img.length-1){
					cent_index++
				}else{
					cent_index=0
				}
				$('.center')[0].src='./imgaes/start_last/'+cent_img[cent_index]+'.png'
			}
			// 按钮点击事件
			function shake() {
				console.log(rand)
				console.log(a)
				if(a == 1) {
					// 随机最大点击次数				
					rand = Math.floor(Math.random() * 10 + 3);
					img.src = "./imgaes/start_last/web-1.png";
					a++
				} else{
					if(index < webs.length) {
						img.src = "./imgaes/start_last/" + webs[index];
						index++
					} else {
						index = 0
						img.src = "./imgaes/start_last/" + webs[index];
					}
					a++
				}
				if(a == rand) {
					ws.send("nr=moveRope&openid="+openid)		
				}
				if(cent_img!=null){
					$('.center')[0].src='./imgaes/start_last/'+cent_img[cent_index]+'.png'
					img.src = "./imgaes/start_last/web-12.png";
					$('.model1')[0].style.display='block';
					// 手机震动
					addPost()
					init()

				}
			}
			
			function addPost() {
				// 添加数据
				$.post(
					// 请求地址
					'http://mq.soratech.cn/web_sock/public/index/index/user_update',
					// 数据data
					{
						"data": addData,
						"openid": openid
					},
					// 成功回调函数
					function(data) {
						console.log(data.data)
					})
			};
			// 初始化
			function init(){
				type = '';

				fishing_openid = ''; // 微信图像id
				fishing_img='';
				
				fishing_name='';

				fishing_sex='' 

				a=1
				index = 0
				btn.removeEventListener('click',shake) // 移除事件
				navigator.vibrate(1000); // 手机震动
			}
		</script>
	</body>

</html>