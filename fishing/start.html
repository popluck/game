<!DOCTYPE HTML>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0,minimun-scale=1,maximum-scale=1,suer-scale=no">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>钓鱼页面</title>
		<link rel="stylesheet" href="./css/bootstrap.min.css" />
		<link rel="stylesheet" href="./css/index.css" />
	</head>

	<body>
		<section id="start">
			<img src="./imgaes/start/BG.png" class="img-responsive start_back" alt="php" />
			<img src="./imgaes/start/start_fish.png" id="start_fish" class="img-responsive start_fish" alt="php" />
			<img class="start_jiyou" src="imgaes/start/矢量智能对象.png" />
			<a class=" start_btn" id="start_btn" href="javascript:;"><img src="./imgaes/start/start_btn.png" class="img-responsive " alt="php" /></a>
		</section>
		<!-- Modal -->
		<div class="model1">
			<div id="" class="model_outside">
				<div id="" class="model_inside">

					<img src="./imgaes/start/start1.png" class="img-responsive model_img" alt="php" />

					<img src="./imgaes/start/start_5.png" class="model_gilf" />
					<img src="./imgaes/start/start4.png" data-dismiss="modal" class=" model_colse" />
					<img src="./imgaes/start/start2.png" class="model_btn" data-dismiss="modal" alt="php" />
				</div>
			</div>
		</div>
		<!-- Modal -->
		<div class="model2 ">
			<div id="" class="model_outside">
				<div id="" class="model_inside">
					<img src="./imgaes/start/基友卡.png" class="img-responsive warehouse_img" alt="php" />
					<div id="" class="warehouse_gilf">
						<img class="img2" src="http://thirdwx.qlogo.cn/mmopen/vi_32/ydQX6UbSCURDQJY1hFCvl8QUpep2mo5Cy2OG7WeUOXhkAGPvlOLBT6xm6dyIYvAsWO22HOFK89hMjPXhlia3yPQ/132" />
						<img class="img1" src="./imgaes/start/框框.png" />
					</div>
					<h3 class="warehouse_name">yangfu</h3>

					<img src="./imgaes/start/按钮-01.png" class="warehouse_btn" data-dismiss="modal" alt="php" />
				</div>
			</div>
		</div>

		<!--<div class="model3 ">
			<div id="" class="model_outside">
				<img src="imgaes/start/矢量智能对象11.png" />
				<img src="imgaes/start/苹果用户点击按钮开始钓鱼.png" />
			</div>
		</div>-->
		<div class="model4">
			<div id="" class="model_outside">
				<div id="" class="model_inside">

					<img src="./imgaes/start/弹窗.png" class="img-responsive model_img" alt="php" />

					<img src="./imgaes/start/您已经将卡片发送至大屏.png" class="model_gilf4" />

					<img src="./imgaes/start/确认.png" class="model_btn4" alt="php" />
				</div>
			</div>
		</div>
		<script src="./js/jquery-3.1.1.min.js"></script>
		</script>
		<script>
			var type = ''; // 类型判断
			var prize = ''; // 合成物品
			var fishing_openid = ''; // 微信图像id
			var fishing_img = ''; // 奖励着微信图像
			var fishing_name = ''; // 奖励微信昵称
			var fishing_sex = ''; // 奖励微信性别
			var fishing_coupons = 'couponsOne'; // 优惠券
//			var wxdata = JSON.parse(localStorage.getItem('wxdata'))
//			var openid = wxdata.openid; // 用户id
//			var nickname = wxdata.nickname; // 用户昵称
//			var sex = wxdata.sex; // 用户性别
//			var head = wxdata.headimgurl // 用户图像
			var room = localStorage.getItem('room')
			var btn = $('.start_btn')[0];
			var img = $('.start_fish')[0];
			var a = 1; //点击数
			var rand; //随机次数
//			$('.warehouse_name')[0].innerText = nickname
			var ws = new WebSocket('ws://118.89.20.208:8585'); // 连接服务器
			// 握手函数
//			$.get(
//				"http://mq.soratech.cn/stores/public/game/index/openid", {
//					code: localStorage.getItem('code')
//				},
//				function(res) {
//					alert(res)
//
//					localStorage.setItem('wxdata', res)
//				})
			$.post(
				"http://mq.soratech.cn/web_sock/public/index/index/user_insert", {
					user: localStorage.getItem('wxdata'),
				},
				function(res) {
					alert(res)
					console.log(1)
				})

			ws.onopen = function() {
				//状态为1证明握手成功，然后把client自定义的名字发送过去
				if(ws.readyState == 1) {
					ws.send('{"type":"add","name":"' + nickname + '","openid":"' + openid + '","head":"' + head + '","sex":"' + sex + '","role":"2","room":"' + room + '"}');
				};
			}
			//握手失败或者其他原因连接socket失败，则清除so对象并做相应提示操作
			ws.onclose = function() {
				ws = false;
			}
			//数据接收监听，接收服务器推送过来的信息，返回的数据给msg，然后进行显示
			ws.onmessage = function(msg) {
				alert(msg, 1)
				// 类型改变
				if(msg.data) {
					var data = JSON.parse(msg.data).nrong;
					console.log(data, 2)
					try {
						data = JSON.parse(data)
						if(data.type == 'moveRope') {
							window.location.href = "start_last.html"
						}
						if(data.prize) {
							type = 'prize';
						}
						if(data.coupons) {
							type = 'coupons';
							fishing_coupons = data.coupons[0];
						}
						if(data.wechat) {
							type = 'wechat';
							fishing_openid = data.wechat[0];
							selType(fishing_openid)
							console.log()
						}
					} catch(e) {}
				}
			}

			function wind() {
				$('.model3')[0].style.display = 'none'
			}
			// 手机摇一摇判断
			if(window.DeviceMotionEvent) {
				var speed = 25;
				var x = y = z = lastX = lastY = lastZ = 0;
				window.addEventListener('devicemotion', function() {
					var acceleration = event.accelerationIncludingGravity;
					x = acceleration.x;
					y = acceleration.y;
					if(Math.abs(x - lastX) > speed || Math.abs(y - lastY) > speed) {
						wind()
						btn.click()
					}
					lastX = x;
					lastY = y;
				}, false);
			}
			$('.model_btn')[0].addEventListener('click', btninit, false)
			$('.warehouse_btn')[0].addEventListener('click', sendTo, false)
			$('.model_colse')[0].addEventListener('click', btninit, false)
			$('.model_btn4')[0].addEventListener('click', btninit, false)
			btn.addEventListener('click', shake, false)

			function btninit() {
				$('.model1')[0].style.display = 'none';
				$('.model2')[0].style.display = 'none';
				$('.model4')[0].style.display = 'none';
				window.location.href = "index.html"
				btn.addEventListener('click', shake, false)
			}

			function sendTo() {
				$('.model4')[0].style.display = 'block';
				btn.addEventListener('click', shake, false)
			}
			// 按钮点击事件
			function shake() {
				alert(1)
				console.log('点击数：' + a)
				console.log('随机数：' + rand)
				if(a == 1) {
					// 随机最大点击次数				
					rand = Math.floor(Math.random() * 10 + 3);
					img.src = "./imgaes/start/start_fish2.png";
					$('.start_jiyou')[0].style.display = 'block'
					a++
				} else {
					if(a % 2 == 0) {
						$('.start_jiyou')[0].style.display = 'none'

						img.src = "./imgaes/start/start_fish.png";
					} else {
						img.src = "./imgaes/start/start_fish2.png";
						$('.start_jiyou')[0].style.display = 'block'
					}
					a++
				}
				// 发消息
				if(a == rand) {
					ws.send('{"type":"msg","content":"moveRope","room":"' + room + '"，"openid":"' + openid + '"}')
					alert('{"type":"msg","content":"moveRope","room":"' + room + '"，"openid":"' + openid + '"}')
				}
				// 获得奖品
				if(type == 'coupons') {
					img.src = "./imgaes/start/start_fish.png";
					$('.model_gilf')[0].src = "imgaes/start_last/" + fishing_coupons + '.png';
					$('.model1')[0].style.display = 'block';
					a = 1
					init()
				}
				if(type == 'prize') {
					prize = 'prize' + String(Math.floor(Math.random() * 5 - 0.5) + 1)
					img.src = "./imgaes/start/start_fish.png";
					$('.model_gilf')[0].src = "imgaes/start_last/" + prize + '.png';
					a = 1
					$('.model1')[0].style.display = 'block';
					init()
				}
				if(type == 'wechat') {
					if(fishing_sex == sex) {
						img.src = "./imgaes/start/start_fish.png";
						$('.warehouse_img')[0].src = 'imgaes/start/基友卡.png';
						$('.img1')[0].src = 'imgaes/start/框框2.png';
						$('.img2')[0].src = fishing_img;
						$('.warehouse_name')[0].innerText = fishing_name
						a = 1
					}
					if(fishing_sex != sex) {
						img.src = "./imgaes/start/start_fish.png";
						$('.warehouse_img')[0].src = 'imgaes/start/桃花卡.png';
						$('.img1')[0].src = 'imgaes/start/框框.png';
						$('.img2')[0].src = fishing_img;
						$('.warehouse_name')[0].innerText = fishing_name
						a = 1
					}
					$('.model2')[0].style.display = 'block';
					console.log(sex, fishing_sex, fishing_name)
					init()
				}
			}
			// 查询信息
			function selType(id) {
				$.post(
					"http://mq.soratech.cn/web_sock/public/index/index/user_sel", {
						'openid': id
					},
					function(msg) {
						try {
							var data = JSON.parse(msg);
							fishing_sex = data.sex;
							fishing_img = data.head;
							fishing_name = data.name;
							console.log(data)

						} catch(e) {
							//TODO handle the exception
						}

					}
				)
			}

			// 发出请求添加数据
			function addType() {
				$.post(
					'http://mq.soratech.cn/web_sock/public/index/index/user_update', // 请求地址
					{
						'data': [{ // 数据data
							'type': type,
							'prize': prize,
							'fishing_openid': fishing_openid,
							'fishing_coupons': fishing_coupons
						}],
						'openid': openid
					},
					function(data) { // 成功回调函数
						console.log(data)
					}
				)
			}

			function init() { // 初始化
				addType() // 请求添加数据

				//				ws.send('')

				type = '';

				btn.removeEventListener('click', shake, false) // 移除事件
				navigator.vibrate(1000); // 手机震动
			}
		</script>
	</body>

</html>